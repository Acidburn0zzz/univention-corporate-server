<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<style>
			body {
				background-color: #e9ecef;
			}
			.container {
				padding: 10ex 10em;
				margin: 0;
			}
			h1 {
			}
			.progress-container {
				background-color: #ffffff;
				border-style: hidden;
				border-radius: 10px;
				padding: 3ex 3em;
			}
			progress {
				width: 100%;
			}
		</style>

    <title>UCS maintenance</title>
  </head>
  <body>
    <div class="container">
      <h1 id="headline">This system is in maintenance mode</h1>
      <p id="explanation">Univention Corporate Server is currently updating. Depending on the release, this may take some time. In /var/log/univention/updater.log, you will find more detailed information on the progress if the update.</p>
      <hr>
			<div class="progress-container">
				<progress id="progressbar" max="100">
				</progress>
      </div>
    </div>

		<script>
			failed = 0;
			progressBar = document.getElementById("progressbar");
			var langRegexp = RegExp("^UMCLang=(.*)$");
			locale = "";
			(document.cookie || "").split(";").forEach(function(cook) {
				var match = langRegexp.exec(cook.trim());
				console.log(cook, match);
				if (match) {
					locale = match[1];
				}
			});
			console.log(locale);
			if (locale.substring(0,2) === "de") {
				document.getElementById("headline").innerHTML = "Dieses System ist im Maintenance-Modus";
				document.getElementById("explanation").innerHTML = "Univention Corporate Server wird gerade aktualisiert. Dies kann je nach Release etwas Zeit in Anspruch nehmen. Die Datei /var/log/univention/updater.log enthält ausführliche Informationen zum Fortschritt des Updates.";
			}
			removeClass = function(elem, cName) {
				element.className.replace(RegExp("/\b" + cName + "\b/g"), "");
			};
			addClass = function(elem, className) {
				var arr = elem.className.split(" ");
				if (arr.indexOf(cName) == -1) {
					elem.className += " " + cName;
				}
			};
			warnUser = function() {
				progressBar.removeAttribute("value");
			};
			setProgress = function(percentage) {
				if (percentage > 0) {
					progressBar.value = percentage;
				} else {
					progressBar.removeAttribute("value");
				}
			};
			interval = 1000;
			checkForReload = function() {
				var xhr = new XMLHttpRequest();
				xhr.timeout = interval;
				xhr.open('GET', document.URL + '?preventCache=' + Math.floor(Math.random() * 100000), true);
				xhr.responseType = 'text';
				xhr.onload = function() {
					if (xhr.readyState === xhr.DONE && xhr.status === 200) {
						if (original_html !== xhr.responseText) {
							console.log("Differing!");
							console.log(original_html);
							console.log(xhr.responseText);
							window.location.reload(true);
						}
					}
				};
				xhr.send(null);
			};
			checkProgress = function() {
				var xhr = new XMLHttpRequest();
				xhr.timeout = interval;
				xhr.open('GET', '/univention/maintenance/updater.json', true);
				xhr.responseType = 'text';
				xhr.onload = function() {
					if (xhr.readyState === xhr.DONE) {
						var fail;
						if (xhr.status === 200 || xhr.status === 304) {
							failed = 0;
							try {
								var json = JSON.parse(xhr.responseText);
								setProgress(json.v1.percentage);
							} catch(err) {
								fail = true;
							}
						} else {
							fail = true;
						}
						if (fail) {
							failed += 1;
							if (failed > 60) {
								warnUser();
							}
							console.log(failed);
						}
					}
				};
				xhr.send(null);
			};
			poll = function() {
				checkForReload();
				checkProgress();
				setTimeout(poll, interval);
			};
			original_html = null;
			var xhr = new XMLHttpRequest();
			xhr.responseType = 'text';
			xhr.open('GET', document.URL + '?preventCache=' + Math.floor(Math.random() * 100000), true);
			xhr.onreadystatechange = function() {
				if (xhr.readyState === xhr.DONE && xhr.status === 200) {
					original_html = xhr.responseText;
					poll();
				}
			};
			xhr.send(null);
		</script>
  </body>
</html>
